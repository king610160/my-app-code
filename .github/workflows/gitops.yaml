name: GitOps-Auto-Update
on:
  push:
    branches: [ main ]
    paths: [ 'app/**' ] # 只有當 app 資料夾變動才觸發

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          # 這裡要用你之前存好的 Secret 名稱
          token: ${{ secrets.MY_GITHUB_TOKEN }} 

      - name: Update Manifest
        run: |
            # 取得目前的版本（簡單檢查一下目前是啥）
            CURRENT_IMG=$(grep "image:" manifests/deployment.yaml)
            
            # 邏輯：如果是 latest 就換成 alpine，反之亦然
            if [[ "$CURRENT_IMG" == *"latest"* ]]; then
                NEW_TAG="alpine"
            else
                NEW_TAG="latest"
            fi
            
            sed -i "s|image: nginx:.*|image: nginx:${NEW_TAG}|g" manifests/deployment.yaml
            
            git config --global user.name "github-actions[bot]"
            git config --global user.email "github-actions[bot]@users.noreply.github.com"
            git add manifests/deployment.yaml
            git commit -m "chore: toggle nginx version to ${NEW_TAG}"
            git push